import React, { useState, useCallback, useRef } from 'react';
import { Download, Upload, CheckCircle2, RotateCcw, Eye, EyeOff, Save, BookOpen, FileJson } from 'lucide-react';

// --- 靜態數據區 ---
const STORY_TITLE = "Cinderella_Part2"; // 設定篇名，用於檔名
const ANSWER_KEY = {
  1: "a cruel woman", 2: "heartless", 3: "in her place", 4: "waver an inch", 5: "How ridiculous!",
  6: "wanted to", 7: "from now on", 8: "for her keep", 9: "clumsy", 10: "on the hearth",
  11: "scatter the cinders all about", 12: "at eight", 13: "hers", 14: "so is a horse's tail",
  15: "stop talking", 16: "either", 17: "prance", 18: "train", 19: "sent your regards",
  20: "wand", 21: "one at a time", 22: "shod with gold", 23: "rat trap", 24: "getting restless",
  25: "It's nothing but rags.", 26: "white velvet", 27: "ermine", 28: "braids", 29: "I've ever seen",
  30: "mind", 31: "refusal", 32: "gaze at", 33: "a matter of state", 34: "very poorly dressed",
  35: "The strangest thing I ever saw!", 36: "with plumes", 37: "awaiting", 38: "can", 39: "spotless",
  40: "the coronation ball", 41: "has proclaimed", 42: "try it on", 43: "In the first place",
  44: "out of sight", 45: "eager to", 46: "pillow", 47: "crooked", 48: "toe", 49: "command",
  50: "cushion", 51: "the mate", 52: "once more", 53: "the wedding chimes", 54: "in"
};

// --- 子組件定義區 ---

// 1. 單個輸入框組件 (維持緊湊)
const CompactInput = React.memo(({ id, value, onChange, showResults }) => {
  const correctAnswer = ANSWER_KEY[id];
  const isCorrect = value?.trim().toLowerCase() === correctAnswer.toLowerCase();
  
  let borderClass = 'border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-100 bg-white';
  if (showResults) {
    borderClass = isCorrect 
      ? 'border-green-500 bg-green-50 text-green-900' 
      : 'border-red-500 bg-red-50 text-red-900';
  }

  return (
    <div className="flex flex-col relative group">
      <div className="flex items-center gap-1.5">
        <span className="shrink-0 flex items-center justify-center w-6 h-6 bg-slate-200 text-slate-600 text-xs font-bold rounded select-none">
          {id}
        </span>
        <input
          type="text"
          className={`w-full px-2 py-1.5 rounded border text-sm transition-all outline-none shadow-sm ${borderClass}`}
          placeholder=""
          value={value || ''}
          onChange={(e) => onChange(id, e.target.value)}
          autoComplete="off"
        />
      </div>
      {showResults && !isCorrect && (
        <div className="text-[10px] text-red-600 pl-8 mt-0.5 font-medium truncate select-none">
          {correctAnswer}
        </div>
      )}
    </div>
  );
});

// 2. 故事卡片組件
const StoryCard = React.memo(({ title, content, questionIds, userAnswers, onInputChange, showResults }) => {
  const renderContent = () => {
    return content.split(/(\(\d+\))/g).map((part, index) => {
      if (part.match(/\(\d+\)/)) {
        return (
          <span key={index} className="bg-yellow-100 text-yellow-800 px-1 rounded font-bold mx-0.5 text-sm box-decoration-clone select-none">
            {part}
          </span>
        );
      }
      return part;
    });
  };

  return (
    <div className="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden mb-4">
      <div className="bg-slate-50 px-3 py-2 border-b border-slate-100 flex items-center gap-2 select-none">
        <BookOpen size={16} className="text-blue-500"/>
        <h3 className="font-bold text-slate-700 text-sm">{title}</h3>
      </div>
      
      <div className="p-3 sm:p-4">
        {/* 閱讀區 */}
        <div className="text-slate-600 leading-relaxed mb-4 text-sm sm:text-base border-l-2 border-blue-200 pl-3">
          {renderContent()}
        </div>

        {/* 填答區 (橫式排列) */}
        <div className="bg-slate-50/80 rounded-lg p-3 border border-slate-100">
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-x-4 gap-y-3">
            {questionIds.map(id => (
              <CompactInput 
                key={id} 
                id={id} 
                value={userAnswers[id]} 
                onChange={onInputChange} 
                showResults={showResults} 
              />
            ))}
          </div>
        </div>
      </div>
    </div>
  );
});

// --- 主程式 ---
const App = () => {
  const [userAnswers, setUserAnswers] = useState({});
  const [showResults, setShowResults] = useState(false);
  const [showAnswerKey, setShowAnswerKey] = useState(false);
  const fileInputRef = useRef(null); // 用於觸發檔案上傳

  const handleInputChange = useCallback((id, value) => {
    setUserAnswers(prev => ({ ...prev, [id]: value }));
  }, []);

  // 1. 備份功能 (JSON)
  const exportBackup = () => {
    // 準備存檔內容
    const dataToSave = {
      title: STORY_TITLE,
      timestamp: new Date().toISOString(),
      answers: userAnswers
    };

    const jsonString = JSON.stringify(dataToSave, null, 2);
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    
    // 設定檔名：Cinderella_Part2_Backup_2024-05-21.json
    const dateStr = new Date().toISOString().slice(0,10);
    const fileName = `${STORY_TITLE}_Backup_${dateStr}.json`;

    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    link.click();
    URL.revokeObjectURL(url);
  };

  // 2. 還原功能 (讀取 JSON)
  const handleImportClick = () => {
    fileInputRef.current.click(); // 觸發隱藏的 input
  };

  const handleFileChange = (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const importedData = JSON.parse(e.target.result);
        
        // 簡單驗證檔案格式
        if (importedData.answers) {
          if (window.confirm(`確認還原備份檔？\n時間：${new Date(importedData.timestamp).toLocaleString()}\n這將會覆蓋您目前的填寫進度。`)) {
            setUserAnswers(importedData.answers);
            // 清空 input 讓使用者可以再次上傳同一個檔案 (若需要)
            event.target.value = ''; 
          }
        } else {
          alert("檔案格式錯誤：找不到答案數據。請確認您上傳的是本網頁產生的 JSON 備份檔。");
        }
      } catch (error) {
        alert("讀取失敗：檔案可能損毀或格式不正確。");
        console.error(error);
      }
    };
    reader.readAsText(file);
  };

  return (
    <div className="min-h-screen bg-slate-100 pb-20 font-sans text-slate-800">
      {/* 隱藏的檔案上傳 Input */}
      <input 
        type="file" 
        ref={fileInputRef}
        style={{ display: 'none' }} 
        accept=".json"
        onChange={handleFileChange}
      />

      {/* Header */}
      <header className="sticky top-0 z-30 bg-white shadow-sm border-b border-slate-200 px-3 py-2">
        <div className="max-w-5xl mx-auto flex items-center justify-between gap-2">
          {/* 左側標題區 */}
          <div className="flex items-center gap-2 overflow-hidden">
            <div className="p-1.5 bg-blue-600 rounded text-white shadow-sm shrink-0">
              <BookOpen size={18} />
            </div>
            <div className="flex flex-col justify-center">
              <h1 className="text-sm sm:text-base font-bold text-slate-800 leading-tight truncate">仙履奇緣 (Cinderella)</h1>
              <p className="text-[10px] text-slate-500 hidden sm:block">Part 2: The Ball & The Slipper</p>
            </div>
          </div>
          
          {/* 右側按鈕區 */}
          <div className="flex items-center gap-1.5 sm:gap-2">
            
            {/* 檢查按鈕 */}
            <button 
              onClick={() => setShowResults(!showResults)}
              className={`flex items-center gap-1 px-3 py-1.5 rounded text-xs font-bold transition-all shadow-sm whitespace-nowrap
                ${showResults ? 'bg-orange-100 text-orange-700 border border-orange-200' : 'bg-green-600 text-white hover:bg-green-700'}`}
            >
              <CheckCircle2 size={16} />
              <span className="hidden sm:inline">{showResults ? '隱藏批改' : '檢查答案'}</span>
              <span className="sm:hidden">{showResults ? '隱藏' : '檢查'}</span>
            </button>

             {/* 分隔線 */}
             <div className="w-px h-6 bg-slate-300 mx-0.5"></div>

            {/* 備份按鈕 */}
            <button 
              onClick={exportBackup}
              className="flex items-center gap-1 px-3 py-1.5 bg-white border border-slate-300 text-slate-700 rounded text-xs font-medium hover:bg-slate-50 shadow-sm whitespace-nowrap"
              title="下載進度備份檔"
            >
              <Download size={16} />
              <span className="hidden sm:inline">備份</span>
            </button>

            {/* 還原按鈕 */}
            <button 
              onClick={handleImportClick}
              className="flex items-center gap-1 px-3 py-1.5 bg-blue-50 border border-blue-200 text-blue-700 rounded text-xs font-medium hover:bg-blue-100 shadow-sm whitespace-nowrap"
              title="上傳並還原進度"
            >
              <Upload size={16} />
              <span className="hidden sm:inline">還原</span>
            </button>

            {/* 清空按鈕 */}
            <button 
              onClick={() => { if(window.confirm('確定要清空所有內容嗎？')) setUserAnswers({}); }}
              className="p-1.5 text-slate-400 hover:text-red-500 transition-colors ml-1"
              title="全部清空"
            >
              <RotateCcw size={18} />
            </button>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="max-w-5xl mx-auto p-3">
        <div className="space-y-3">
            {/* Page 165 */}
            <StoryCard 
                title="Page 165 (CD 21)"
                content="Once upon a time, (1) married a man she didn’t love. Then, demanding that he journey far away to increase their wealth, she took her two (2) daughters and arrived at her new husband’s home... “The first thing is to put this daughter of his (3).”"
                questionIds={[1, 2, 3]}
                userAnswers={userAnswers}
                onInputChange={handleInputChange}
                showResults={showResults}
            />

            {/* Page 166-167 */}
            <StoryCard 
                title="Page 166-167 (CD 22)"
                content="“Remember—don’t (4)!” ... “Indeed you may not! (5)” ... “I only (6) welcome you to our house.” ... “Your house? Please remember, girl, that (7), this isn’t your house but ours.”"
                questionIds={[4, 5, 6, 7]}
                userAnswers={userAnswers}
                onInputChange={handleInputChange}
                showResults={showResults}
            />

            {/* Page 168 */}
            <StoryCard 
                title="Page 168"
                content="“She might as well know she’ll have to work (8).” ... “She’s too ugly and (9)!” ... “Why are you sitting over there (10), Simpleton? You’ll (11) the room.”"
                questionIds={[8, 9, 10, 11]}
                userAnswers={userAnswers}
                onInputChange={handleInputChange}
                showResults={showResults}
            />

            {/* Page 169-170 */}
            <StoryCard 
                title="Page 169-170 (CD 23-24)"
                content="“I told you to have everything ready for the girls (12).” ... “Yes, you’d better do (13) first... Then (14)!” ... “Oh, (15) and fasten Isabella’s dress!” ... “Don’t spill your tears on my gown (16)!” ... “Look how they (17)! ... And pick up your (18), Flora! ... I’ll tell the prince that you (19)!”"
                questionIds={[12, 13, 14, 15, 16, 17, 18, 19]}
                userAnswers={userAnswers}
                onInputChange={handleInputChange}
                showResults={showResults}
            />

            {/* Page 172-174 */}
            <StoryCard 
                title="Page 172-174 (CD 26-27)"
                content="“Now, do you see this magic (20) I have in my hand?” ... “Open the door of the trap and let them out (21). ... They’re (22)! ... Fetch me that (23) by the cellar steps.” ... “Whoa! These horses are (24), waiting, Princess.” ... “But fairy godmother, look at my dress. (25)”"
                questionIds={[20, 21, 22, 23, 24, 25]}
                userAnswers={userAnswers}
                onInputChange={handleInputChange}
                showResults={showResults}
            />

            {/* Page 175-176 */}
            <StoryCard 
                title="Page 175-176 (CD 28-29)"
                content="“A dress of creamy (26) trimmed in (27).” ... “Silver and crystal roses entwined in my (28).” ... “The loveliest slippers (29)!” ... “Go to the ball, but (30) you must return before the clock strikes twelve.” ... “In spite of her stepmother’s (31), Cinderella... drove to the ball. ... I need nothing more than to (32) you.”"
                questionIds={[26, 27, 28, 29, 30, 31, 32]}
                userAnswers={userAnswers}
                onInputChange={handleInputChange}
                showResults={showResults}
            />

            {/* Page 178-180 */}
            <StoryCard 
                title="Page 178-180 (CD 30-31)"
                content="“I must see the princess for a moment to discuss (33).” ... “No, sire. Only a (34) girl went this way.” ... “I was so excited watching something else. (35)” ... “Six prancing horses (36) on their heads... and six footmen (37).”"
                questionIds={[33, 34, 35, 36, 37]}
                userAnswers={userAnswers}
                onInputChange={handleInputChange}
                showResults={showResults}
            />

            {/* Page 181-182 */}
            <StoryCard 
                title="Page 181-182 (CD 33)"
                content="“If anybody (38) wear it, I can!” ... “The place must look (39) when the prince enters.” ... “Lost one of her glass slippers at (40) the other night?” ... “And the prince (41) he would marry the girl.” ... “May I (42), please?” ... “(43), your feet are bigger than ours. ... See that you keep (44)!”"
                questionIds={[38, 39, 40, 41, 42, 43, 44]}
                userAnswers={userAnswers}
                onInputChange={handleInputChange}
                showResults={showResults}
            />

            {/* Page 183-186 */}
            <StoryCard 
                title="Page 183-186 (CD 34-35)"
                content="“My daughters are (45) try on the glass slipper. ... Put your right foot on the (46), my lady.” ... “You put it on (47)!” ... “No, my lady. Only your big (48)…” ... “I (49) that you try it on immediately. ... Here. Sit on this (50).”"
                questionIds={[45, 46, 47, 48, 49, 50]}
                userAnswers={userAnswers}
                onInputChange={handleInputChange}
                showResults={showResults}
            />

            {/* Page 187-188 */}
            <StoryCard 
                title="Page 187-188 (CD 36)"
                content="“And here is (51) to the slipper in my pocket.” ... “My lovely Cinderella, (52) I ask you...” ... “Then let (53) announce that I have found the lady of my heart. ... The loveliest maiden (54) all the world.”"
                questionIds={[51, 52, 53, 54]}
                userAnswers={userAnswers}
                onInputChange={handleInputChange}
                showResults={showResults}
            />
        </div>

        {/* Answer Key Toggle */}
        <div className="mt-8 flex justify-center pb-10">
          <button 
            onClick={() => setShowAnswerKey(!showAnswerKey)}
            className="flex items-center gap-2 bg-white px-4 py-2 rounded-full shadow-sm border border-slate-200 text-slate-600 text-sm hover:bg-slate-50 transition-colors"
          >
            {showAnswerKey ? <EyeOff size={16} /> : <Eye size={16} />}
            {showAnswerKey ? '隱藏解答' : '查看完整解答表'}
          </button>
        </div>
          
        {showAnswerKey && (
            <div className="mb-10 p-4 bg-white rounded-lg shadow-sm border border-slate-200 grid grid-cols-2 md:grid-cols-4 gap-2 select-none">
              {Object.entries(ANSWER_KEY).map(([num, val]) => (
                <div key={num} className="flex gap-2 text-xs p-1 hover:bg-slate-50 rounded border-b border-slate-50">
                  <span className="font-bold text-blue-600 min-w-[20px]">{num}.</span>
                  <span className="text-slate-700">{val}</span>
                </div>
              ))}
            </div>
        )}

      </main>

      <footer className="max-w-5xl mx-auto px-4 py-6 text-center text-slate-400 text-xs">
        Cinderella Interactive Tool &copy; English Audio Book Series.
      </footer>
    </div>
  );
};

export default App;

